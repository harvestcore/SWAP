# Práctica 5



## Objetivos

- Crear una BD con al menos una tabla y algunos datos.
- Realizar la copia de seguridad de la BD completa usando mysqldump en la
  máquina principal y copiar el archivo de copia de seguridad a la máquina
  secundaria.
- Restaurar dicha copia de seguridad en la segunda máquina (clonado manual
  de la BD), de forma que en ambas máquinas esté esa BD de forma idéntica.
- Realizar la configuración maestro-esclavo de los servidores MySQL para que la
  replicación de datos se realice automáticamente.



## Tareas opcionales

- Realizar la configuración maestro-maestro de los servidores MySQL.



## Desarrollo

Para el desarrollo de los objetivos usaré las máquinas con Nginx y HAProxy, donde la primera será el maestro y la segunda el esclavo.

### Crear una BD con al menos una tabla y algunos datos.

Crear la BD:

```sql
CREATE DATABASE swap_pr;
```

Seleccionar la BD *swap_pr*:

```sql
USE swap_pr;
```

Crear una tabla (en mi caso se llama practicas):

```sql
CREATE TABLE practicas(
	nombre varchar(100),
	tema int,
    longitud int
);
```

Introducir algunos datos:

```sql
insert into practicas(nombre, tema, longitud) values ("Replicación de BD en MySQL", 5, 10);
insert into practicas(nombre, tema, longitud) values ("Certificados SSL", 4, 20);
```

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\11.PNG)



### Realizar la copia de seguridad de la BD completa usando mysqldump.

Para realizar el volcado de la BD a un archivo .sql solo hay que ejecutar lo siguiente:

```bash
mysqldump swap_pr -u root -p > swap_pr.sql
```

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\12.PNG)

Ahora con scp (desde la máquina 2) transfiero el archivo:

```bash
scp 192.168.56.10:/home/web00/swap_pr.sql /home/web00/
```

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\13.PNG)



### Restaurar copia de seguridad en la segunda máquina.

Lo primero que hago es acceder a mysql en la segunda máquina y creo una base de datos con el mismo nombre que la de la máquina 1:

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\14.PNG)

Tras eso ejecuto lo siguiente para restaurar la BD:

```bash
mysql -u root -p swap_pr < swap_pr.sql
```

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\15.PNG)



### Configuración maestro-esclavo.

#### Configuración del maestro (Nginx)

Modificamos el archivo */etc/mysql/mysql.conf.d/mysql.conf* y comentamos la línea siguiente (para permitir que el esclavo se pueda conectar al maestro):

```bash
#bind-address 127.0.01
```

Y ahora reiniciamos el servicio con:

```bash
sudo service mysql restart
```

Ahora tenemos que acceder a MySQL y crear un usuario que realice la replicación, y además le damos permisos de replicación:

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\16.PNG)

![](C:\Users\Angel\Dropbox\Universidad\Tercero\Segundo Cuatri\SWAP\practicas\p5\images\17.PNG)

Ahora ejecutamos:

```sql
FLUSH PRIVILEGES;
FLUSH TABLES;
FLUSH TABLES WITH READ LOCK;
```

Por otro lado ejecutamos, lo que nos proporcionará información necesaria para configurar la replicación en el esclavo:

```sql
SHOW MASTER STATUS;
```



